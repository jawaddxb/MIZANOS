# Improve System Document Formatting

## Context
System documents are generated by the LLM as Markdown, but the `DocViewer` component in `SystemDocsTab.tsx` renders `doc.content` as **raw text** — headings show as `##`, bold shows as `**text**`, and ASCII art diagrams render broken. The codebase already has `EnhancedMarkdownViewer` with full Markdown rendering (code blocks, tables, callouts, headings). We need to wire it up and enhance the LLM prompts to produce richer content with Mermaid diagrams.

## Changes

### 1. Use EnhancedMarkdownViewer in DocViewer (Frontend)

**File:** `apps/web/src/components/organisms/product/SystemDocsTab.tsx`

Replace the raw text `<div>` in `DocViewer` (line 196-199) with `EnhancedMarkdownViewer`:

```tsx
// Before:
<div className="prose prose-sm dark:prose-invert max-w-none text-sm leading-relaxed whitespace-pre-wrap">
  {doc.content || "No content available."}
</div>

// After:
<EnhancedMarkdownViewer content={doc.content || "No content available."} />
```

This instantly gives us: headings, bold/italic, code blocks with syntax highlighting, tables, callouts, links, and lists — all already styled.

### 2. Add Mermaid diagram rendering (Frontend)

**File:** `apps/web/src/components/molecules/display/EnhancedMarkdownViewer.tsx`

Install `mermaid` package, then extend the `code` component override to detect `language-mermaid` blocks and render them as SVG diagrams instead of code blocks.

Add a `MermaidBlock` component that:
- Takes the mermaid source string
- Uses `mermaid.render()` to produce SVG
- Renders the SVG inside a styled container

Update the `code` handler in `MarkdownComponents()`:
```
if language === "mermaid" → render <MermaidBlock>
else if language match → render <CodeBlock>
else → render inline <code>
```

### 3. Improve LLM system prompts (Backend)

**File:** `apps/api/services/system_doc_generator.py`

Enhance `_SYSTEM_PROMPTS` with explicit formatting instructions:

- Use Mermaid code blocks for diagrams (architecture layers, user flows, data models, deployment pipelines)
- Use Markdown tables for structured data (tech stack, API endpoints, environment variables)
- Use `> [!info]` / `> [!warning]` callout syntax for important notes
- Use bold/italic for emphasis on key terms
- Use proper heading hierarchy (## for sections, ### for subsections)
- No ASCII art — use Mermaid instead

### 4. Install mermaid dependency

```bash
cd apps/web && npm install mermaid
```

## Files to Modify

| File | Change |
|------|--------|
| `apps/web/package.json` | Add `mermaid` dependency |
| `apps/web/src/components/organisms/product/SystemDocsTab.tsx` | Import and use `EnhancedMarkdownViewer` in `DocViewer` |
| `apps/web/src/components/molecules/display/EnhancedMarkdownViewer.tsx` | Add `MermaidBlock` component + wire into code handler |
| `apps/api/services/system_doc_generator.py` | Rewrite `_SYSTEM_PROMPTS` with formatting instructions |

## Verification

1. `make dev` is already running
2. Open product → System Docs → click "Regenerate" (to get new docs with improved prompts)
3. Verify: headings render as actual headings, tables render as tables, code blocks have syntax highlighting
4. Verify: Mermaid diagrams render as SVG (architecture diagrams, flowcharts, etc.)
5. Verify: callouts render with colored boxes for `[!info]`, `[!warning]`
6. Existing docs (before regeneration) should also render properly since the markdown renderer handles standard markdown
